apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: k6-test-grafana
  namespace: k6-operator
spec:
  parallelism: 1
  script:
    configMap:
      name: k6-test-grafana-script
      file: test.js
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-test-grafana-script
  namespace: k6-operator
data:
  test.js: |
    import http from 'k6/http';
    import { sleep, check } from 'k6';

    export const options = {
      stages: [
        { duration: '30s', target: 10 },   // 10 VUs로 램프업
        { duration: '1m', target: 10 },    // 1분간 10 VUs 유지
        { duration: '30s', target: 0 },    // 램프다운
      ],
      thresholds: {
        http_req_duration: ['p(95)<1000'],
        http_req_failed: ['rate<0.1'],
      },
    };

    export default function () {
      // Grafana Service 테스트 (monitoring 네임스페이스)
      const url = 'http://grafana.monitoring.svc.cluster.local';
      
      const res = http.get(url, {
        headers: {
          'Accept': 'text/html',
        },
      });
      
      check(res, {
        'status is 200': (r) => r.status === 200,
        'response time < 1s': (r) => r.timings.duration < 1000,
        'has grafana content': (r) => r.body.includes('Grafana'),
      });
      
      sleep(1);
    }
