apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: k6-test-batch-post
  namespace: k6-operator
spec:
  parallelism: 1
  script:
    configMap:
      name: k6-test-batch-post-script
      file: test.js
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-test-batch-post-script
  namespace: k6-operator
data:
  test.js: |
    import http from 'k6/http';
    import { sleep, check } from 'k6';
    import { Counter, Trend } from 'k6/metrics';

    // 커스텀 메트릭
    const batchCounter = new Counter('batch_jobs_total');
    const batchSuccess = new Counter('batch_jobs_success');
    const batchFailed = new Counter('batch_jobs_failed');
    const batchDuration = new Trend('batch_job_duration');

    export const options = {
      // 점진적 배치 증가 시나리오
      stages: [
        { duration: '1m', target: 2 },    // 워밍업: 2개 배치
        { duration: '2m', target: 5 },    // 5개 배치로 증가
        { duration: '2m', target: 8 },    // 8개 배치로 증가  
        { duration: '2m', target: 12 },   // 12개 배치로 증가
        { duration: '2m', target: 15 },   // 최대: 15개 배치
        { duration: '3m', target: 15 },   // 피크 유지
        { duration: '1m', target: 0 },    // 쿨다운
      ],
      
      thresholds: {
        'http_req_duration': ['p(95)<90000'],      // 95%가 90초 이내
        'http_req_failed': ['rate<0.05'],          // 실패율 5% 미만
        'batch_job_duration': ['p(90)<60000'],     // 90%가 60초 이내
        'batch_jobs_success': ['count>30'],        // 최소 30개 성공
      },
    };

    export default function () {
      const batchId = `batch-${Date.now()}-${__VU}`;
      const startTime = new Date();
      
      console.log(`[${startTime.toISOString()}] 배치 ${batchId} 시작 (VU: ${__VU})`);
      batchCounter.add(1);
      
      // ====================================
      // 여기에 실제 배치 작업 URL 입력
      // ====================================
      const url = 'http://your-service.your-namespace.svc.cluster.local/api/batch';
      
      // 배치 작업 데이터 (실제 데이터로 변경)
      const payload = JSON.stringify({
        batchId: batchId,
        timestamp: startTime.toISOString(),
        data: {
          // 실제 배치 작업 데이터
          items: Array.from({ length: 100 }, (_, i) => ({
            id: i,
            value: Math.random() * 1000,
          })),
        },
      });
      
      const params = {
        headers: {
          'Content-Type': 'application/json',
          'X-Batch-ID': batchId,
        },
        timeout: '120s',  // 배치 작업 최대 2분
      };
      
      // 배치 작업 실행
      const res = http.post(url, payload, params);
      
      const endTime = new Date();
      const duration = endTime.getTime() - startTime.getTime();
      batchDuration.add(duration);
      
      // 결과 검증
      const success = check(res, {
        '상태 코드 2xx': (r) => r.status >= 200 && r.status < 300,
        '응답 시간 2분 이내': (r) => r.timings.duration < 120000,
        '응답 본문 포함': (r) => r.body && r.body.length > 0,
      });
      
      if (success) {
        batchSuccess.add(1);
        console.log(`[${endTime.toISOString()}] ✅ 배치 ${batchId} 성공 (소요: ${duration}ms, 상태: ${res.status})`);
      } else {
        batchFailed.add(1);
        console.error(`[${endTime.toISOString()}] ❌ 배치 ${batchId} 실패 (소요: ${duration}ms, 상태: ${res.status})`);
      }
      
      // 배치 간격 (배치가 길게 실행되므로 짧은 대기)
      sleep(Math.random() * 5 + 2);  // 2~7초 랜덤 대기
    }

    // 테스트 완료 후 상세 요약
    export function handleSummary(data) {
      const totalBatches = data.metrics.batch_jobs_total?.values?.count || 0;
      const successBatches = data.metrics.batch_jobs_success?.values?.count || 0;
      const failedBatches = data.metrics.batch_jobs_failed?.values?.count || 0;
      
      const summary = {
        test_duration: data.state.testRunDurationMs / 1000 + 's',
        batch_statistics: {
          total: totalBatches,
          success: successBatches,
          failed: failedBatches,
          success_rate: totalBatches > 0 ? ((successBatches / totalBatches) * 100).toFixed(2) + '%' : '0%',
        },
        performance: {
          avg_batch_duration: (data.metrics.batch_job_duration?.values?.avg || 0).toFixed(0) + 'ms',
          p50_batch_duration: (data.metrics.batch_job_duration?.values?.['p(50)'] || 0).toFixed(0) + 'ms',
          p90_batch_duration: (data.metrics.batch_job_duration?.values?.['p(90)'] || 0).toFixed(0) + 'ms',
          p95_batch_duration: (data.metrics.batch_job_duration?.values?.['p(95)'] || 0).toFixed(0) + 'ms',
          max_batch_duration: (data.metrics.batch_job_duration?.values?.max || 0).toFixed(0) + 'ms',
        },
        http_metrics: {
          avg_request_duration: (data.metrics.http_req_duration?.values?.avg || 0).toFixed(0) + 'ms',
          p95_request_duration: (data.metrics.http_req_duration?.values?.['p(95)'] || 0).toFixed(0) + 'ms',
          failed_requests: (data.metrics.http_req_failed?.values?.rate * 100).toFixed(2) + '%',
        },
      };
      
      console.log('\n' + '='.repeat(60));
      console.log('배치 부하 테스트 결과 요약');
      console.log('='.repeat(60));
      console.log(JSON.stringify(summary, null, 2));
      console.log('='.repeat(60) + '\n');
      
      return {
        'stdout': JSON.stringify(summary, null, 2),
      };
    }
